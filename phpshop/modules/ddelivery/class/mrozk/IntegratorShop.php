<?php
/**
 * Created by PhpStorm.
 * User: mrozk
 * Date: 4/28/14
 * Time: 11:47 AM
 */

use DDelivery\Order\DDeliveryProduct;
use DDelivery\Adapter\PluginFilters;
use DDelivery\Order\DDStatusProvider;
//ini_set("display_errors", "1");
//error_reporting(E_ALL);

class IntegratorShop extends PluginFilters {

    public $cmsSettings;

    public $fields;

    protected  $cmsOrderStatus = array( DDStatusProvider::ORDER_IN_PROGRESS => 0,
                                        DDStatusProvider::ORDER_CONFIRMED => 2,
                                        DDStatusProvider::ORDER_IN_STOCK => 14,
                                        DDStatusProvider::ORDER_IN_WAY => 15,
                                        DDStatusProvider::ORDER_DELIVERED => 16,
                                        DDStatusProvider::ORDER_RECEIVED => 17,
                                        DDStatusProvider::ORDER_RETURN => 20,
                                        DDStatusProvider::ORDER_CUSTOMER_RETURNED => 21,
                                        DDStatusProvider::ORDER_PARTIAL_REFUND => 22,
                                        DDStatusProvider::ORDER_RETURNED_MI => 2,
                                        DDStatusProvider::ORDER_WAITING => 25,
                                        DDStatusProvider::ORDER_CANCEL => 26 );

    public function __construct( $fields = array() )
    {
        global $link_db;
        $this->fields = $fields;
        $this-$link_db = $link_db;
        $query = 'SELECT * FROM ddelivery_module_system WHERE id = 1';
        $cur = mysqli_query($this->link_db,$query);
        $this->cmsSettings = mysql_fetch_assoc($cur);

    }


    /**
     * РќР°СЃС‚СЂРѕР№РєРё Р±Р°Р·С‹ РґР°РЅРЅС‹С…
     * @return array
     */
    public function getDbConfig(){
        $user_db = $GLOBALS['SysValue']['connect']['user_db'];
        $pass_db = $GLOBALS['SysValue']['connect']['pass_db'];
        $dbase = $GLOBALS['SysValue']['connect']['dbase'];
        $host = $GLOBALS['SysValue']['connect']['host'];

        return array(
            'pdo' => new \PDO('mysql:host=' . $host . ';dbname=' . $dbase , $user_db, $pass_db, array(\PDO::MYSQL_ATTR_INIT_COMMAND => "SET NAMES cp1251")),
            'prefix' => 'ddelivery_module_',
        );

        return array(
            'type' => self::DB_SQLITE,
            'dbPath' => $this->getPathByDB(),
            'prefix' => '',
        );

        return array(
            'type' => self::DB_MYSQL,
            'dsn' => 'mysql:host=localhost;dbname=ddelivery',
            'user' => 'root',
            'pass' => '0',
            'prefix' => '',
        );
    }

    public function isStatusToSendOrder( $status ){
        if( $this->cmsSettings['status'] == $status )
        {
            return true;
        }
        return false;
    }
    /**
     * Р’РµСЂРЅРёС‚Рµ true РµСЃР»Рё РЅСѓР¶РЅРѕ РёСЃРїРѕР»СЊР·РѕРІР°С‚СЊ С‚РµСЃС‚РѕРІС‹Р№(stage) СЃРµСЂРІРµСЂ
     * @return bool
     */
    public function isTestMode()
    {
        if ( $this->cmsSettings['rezhim']  == '0')
        {
            return true;
        }
        elseif($this->cmsSettings['rezhim']  == '1')
        {
            return false;
        }
        // TODO: Change the autogenerated stub
    }

    /**
     * Р’РѕР·РІСЂР°С‰Р°РµС‚ С‚РѕРІР°СЂС‹ РЅР°С…РѕРґСЏС‰РёРµСЃСЏ РІ РєРѕСЂР·РёРЅРµ РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ, Р±СѓРґРµС‚ РІС‹Р·РІР°РЅ РѕРґРёРЅ СЂР°Р·, Р·Р°С‚РµРј Р·Р°РєРµС€РёСЂРѕРІР°РЅ
     * @return DDeliveryProduct[]
     */
    protected function _getProductsFromCart()
    {

        $products = array();
        // РљРѕСЂР·РёРЅР°
        $PHPShopCart = new PHPShopCart();
        $productsCart = $PHPShopCart->getArray();


        if( count( $productsCart ) ){
            foreach($productsCart as $item)
            {

                $PHPShopProduct = new PHPShopProduct($item['id']);


                $cartWidth = $PHPShopProduct->getParam("option1");
                $cartLenght = $PHPShopProduct->getParam("option2");
                $cartHeight = $PHPShopProduct->getParam("option3");


                $cartWeight = $item['weight'] / 1000;


                $width = (empty($cartWidth)?$this->cmsSettings['def_width']:$cartWidth);
                $lenght = (empty($cartLenght)?$this->cmsSettings['def_lenght']:$cartLenght);
                $height = (empty($cartHeight)?$this->cmsSettings['def_height']:$cartHeight);
                $weight = (empty($cartWeight)?$this->cmsSettings['def_weight']:$cartWeight);

                $products[] = new \DDelivery\Order\DDeliveryProduct( $item['id'],
                    $width, $height, $lenght, $weight,
                    $item['price'], $item['num'], iconv('windows-1251', 'UTF-8',$item['name']), $item['id'] );


            }
        }

        return $products;
    }

    /**
     * РњРµРЅСЏРµС‚ СЃС‚Р°С‚СѓСЃ РІРЅСѓС‚СЂРµРЅРЅРµРіРѕ Р·Р°РєР°Р·Р° cms
     *
     * @param $cmsOrderID - id Р·Р°РєР°Р·Р°
     * @param $status - СЃС‚Р°С‚СѓСЃ Р·Р°РєР°Р·Р° РґР»СЏ РѕР±РЅРѕРІР»РµРЅРёСЏ
     *
     * @return bool
     */
    public function setCmsOrderStatus($cmsOrderID, $status){
        $orders = $GLOBALS['SysValue']['base']['orders'];
        $query = 'UPDATE ' . $orders . ' SET statusi = ' . $status . ' WHERE id = ' . $cmsOrderID;
        $cur = mysqli_query($this->link_db,$query);
        $this->cmsSettings = mysql_fetch_assoc($cur);
    }

    public function getOrderIDsByStatus(){
        $orders = $GLOBALS['SysValue']['base']['orders'];

        $query = 'SELECT uid FROM ' . $orders . ' WHERE statusi =' . $this->cmsSettings['status'];
        $cur = mysqli_query($this->link_db,$query);
        $result = array();
        while ($k = mysql_fetch_array($cur))
        {
            $result[] = $k[0];
        }

        return $result;
    }

    /**
     * Р’РѕР·РІСЂР°С‰Р°РµС‚ API РєР»СЋС‡, РІС‹ РјРѕР¶РµС‚Рµ РїРѕР»СѓС‡РёС‚СЊ РµРіРѕ РґР»СЏ Р’Р°С€РµРіРѕ РїСЂРёР»РѕР¶РµРЅРёСЏ РІ Р»РёС‡РЅРѕРј РєР°Р±РёРЅРµС‚Рµ
     * @return string
     */
    public function getApiKey()
    {
        return $this->cmsSettings['api'];
    }

    /**
     * Р”РѕР»Р¶РµРЅ РІРµСЂРЅСѓС‚СЊ url РґРѕ РєР°С‚Р°Р»РѕРіР° СЃ СЃС‚Р°С‚РёРєРѕР№
     * @return string
     */
    public function getStaticPath()
    {
        return '../html/';
    }

    /**
     * URL РґРѕ СЃРєСЂРёРїС‚Р° РіРґРµ РІС‹Р·С‹РІР°РµС‚СЃСЏ DDelivery::render
     * @return string
     */
    public function getPhpScriptURL()
    {
        // РўРѕРµСЃС‚СЊ РґРѕ СЌС‚РѕРіРѕ С„Р°Р№Р»Р°
        unset( $this->fields['iframe'] );
        return 'ajax.php?' . http_build_query($this->fields);
    }

    /**
     * Р’РѕР·РІСЂР°С‰Р°РµС‚ РїСѓС‚СЊ РґРѕ С„Р°Р№Р»Р° Р±Р°Р·С‹ РґР°РЅРЅС‹С…, РїРѕР»РѕР¶РёС‚Рµ РµРіРѕ РІ РјРµСЃС‚Рѕ РЅРµ РґРѕСЃС‚СѓРїРЅРѕРµ РїРѕ РїСЂСЏРјРѕР№ СЃСЃС‹Р»РєРµ
     * @return string
     */
    public function getPathByDB()
    {
        return __DIR__.'/../db/db.sqlite';
    }

    /**
     * РњРµС‚РѕРґ Р±СѓРґРµС‚ РІС‹Р·РІР°РЅ РєРѕРіРґР° РїРѕР»СЊР·РѕРІР°С‚РµР»СЊ Р·Р°РєРѕРЅС‡РёС‚ РІС‹Р±РѕСЂ СЃРїРѕСЃРѕР±Р° РґРѕСЃС‚Р°РІРєРё
     *
     * @param int $orderId
     * @param \DDelivery\Order\DDeliveryOrder $order
     * @param bool $customPoint Р•СЃР»Рё true, С‚Рѕ Р·Р°РєР°Р· РѕР±СЂР°Р±Р°С‚С‹РІР°РµС‚СЃСЏ РјР°РіР°Р·РёРЅРѕРј
     * @return void
     */
    public function onFinishChange($order)
    {

    }

    /**
     * РљР°РєРѕР№ РїСЂРѕС†РµРЅС‚ РѕС‚ СЃС‚РѕРёРјРѕСЃС‚Рё СЃС‚СЂР°С…СѓРµС‚СЃСЏ
     * @return float
     */
    public function getDeclaredPercent()
    {
        return $this->cmsSettings['declared'];
    }


    /**
     * Р”РѕР»Р¶РµРЅ РІРµСЂРЅСѓС‚СЊ С‚Рµ РєРѕРјРїР°РЅРёРё РєРѕС‚РѕСЂС‹Рµ  РїРѕРєР°Р·С‹РІР°СЋС‚СЃСЏ РІ РєСѓСЂСЊРµСЂРєРµ
     *
     * @return int[]
     */
    public function filterCompanyPointCourier(){
        $cur_companies = unserialize( $this->cmsSettings['cur_companies'] );
        if( empty( $cur_companies ) )
        {
            $res = array();
        }
        else
        {
            $res = array_values($cur_companies) ;
        }
        return $res;
        // TODO: Implement filterCompanyPointCourier() method.
    }

    /**
     * Р”РѕР»Р¶РµРЅ РІРµСЂРЅСѓС‚СЊ С‚Рµ РєРѕРјРїР°РЅРёРё РєРѕС‚РѕСЂС‹Рµ  РїРѕРєР°Р·С‹РІР°СЋС‚СЃСЏ РІ СЃР°РјРѕРІС‹РІРѕР·Рµ
     *
     * @return int[]
     */
    public function filterCompanyPointSelf(){
        $cur_companies = unserialize( $this->cmsSettings['pvz_companies'] );
        if( empty( $cur_companies ) )
        {
            $res = array();
        }
        else
        {
            $res = array_values($cur_companies) ;
        }
        return $res;
        // TODO: Implement filterCompanyPointSelf() method.
    }



    /**
     * Р’РѕР·РІСЂР°С‰Р°РµРј СЃРїРѕСЃРѕР± РѕРїР»Р°С‚С‹ РєРѕРЅСЃС‚Р°РЅС‚РѕР№ PluginFilters::PAYMENT_, РїСЂРµРґРѕРїР»Р°С‚Р° РёР»Рё РѕРїР»Р°С‚Р° РЅР° РјРµСЃС‚Рµ. РљСѓСЂСЊРµСЂ
     * @return int
     */
    public function filterPointByPaymentTypeCourier($order)
    {
        return $this->cmsSettings['payment'];
        /*
        return self::PAYMENT_POST_PAYMENT;
        // РІС‹Р±РёСЂР°РµРј РѕРґРёРЅ РёР· 3 РІР°СЂРёР°РЅС‚РѕРІ(СЃРј РґРѕРєСѓРјРµРЅС‚Р°С†РёСЋ РёР»Рё РєРѕРјРјРµРЅС‚С‹ Рє РєРѕРЅСЃС‚Р°С‚Р°Рј)
        return self::PAYMENT_POST_PAYMENT;
        return self::PAYMENT_PREPAYMENT;
        return self::PAYMENT_NOT_CARE;
        */
        // TODO: Implement filterPointByPaymentTypeCourier() method.
    }

    /**
     * Р’РѕР·РІСЂР°С‰Р°РµРј СЃРїРѕСЃРѕР± РѕРїР»Р°С‚С‹ РєРѕРЅСЃС‚Р°РЅС‚РѕР№ PluginFilters::PAYMENT_, РїСЂРµРґРѕРїР»Р°С‚Р° РёР»Рё РѕРїР»Р°С‚Р° РЅР° РјРµСЃС‚Рµ. РЎР°РјРѕРІС‹РІРѕР·
     * @return int
     */
    public function filterPointByPaymentTypeSelf($order)
    {
        return $this->cmsSettings['payment'];
        //return self::PAYMENT_POST_PAYMENT;
        // РІС‹Р±РёСЂР°РµРј РѕРґРёРЅ РёР· 3 РІР°СЂРёР°РЅС‚РѕРІ(СЃРј РґРѕРєСѓРјРµРЅС‚Р°С†РёСЋ РёР»Рё РєРѕРјРјРµРЅС‚С‹ Рє РєРѕРЅСЃС‚Р°С‚Р°Рј)
        /*
        return self::PAYMENT_POST_PAYMENT;
        return self::PAYMENT_PREPAYMENT;
        return self::PAYMENT_NOT_CARE;
        // TODO: Implement filterPointByPaymentTypeSelf() method.
        */
    }
    public function getClientLastName() {
        return '';
    }
    /**
     * Р•СЃР»Рё true, С‚Рѕ РЅРµ СѓС‡РёС‚С‹РІР°РµС‚ С†РµРЅСѓ Р·Р°Р±РѕСЂР°
     * @return bool
     */
    public function isPayPickup()
    {
        $zabor = (int)$this->cmsSettings['zabor'];
        if( $zabor ) return true;
        else         return false;
        // TODO: Implement isPayPickup() method.
    }

    /**
     * РњРµС‚РѕРґ РІРѕР·РІСЂР°С‰Р°РµС‚ РЅР°СЃС‚СЂРѕР№РєРё РѕРїР»Р°С‚С‹ С„РёР»СЊС‚СЂР° РєРѕС‚РѕСЂС‹Рµ РґРѕР»Р¶РЅС‹ Р±С‹С‚СЊ СЃРѕР±СЂР°РЅС‹ РёР· Р°РґРјРёРЅРєРё
     *
     * @return array
     */
    public function getIntervalsByPoint()
    {
        $result = array();
        if( isset( $this->cmsSettings['from1'] ) &&  isset( $this->cmsSettings['to1'] ) && !empty( $this->cmsSettings['method1'] ) &&
            !empty( $this->cmsSettings['methodval1'] ) )
        {
            $result[] = array('min' => $this->cmsSettings['from1'], 'max'=>$this->cmsSettings['to1'],
                              'type'=>$this->cmsSettings['method1'], 'amount'=>$this->cmsSettings['methodval1']);
        }
        if( !empty( $this->cmsSettings['from2'] ) &&  !empty( $this->cmsSettings['to2'] ) && !empty( $this->cmsSettings['method2'] ) &&
            !empty( $this->cmsSettings['methodval2'] )  )
        {
            $result[] = array('min' => $this->cmsSettings['from2'], 'max'=>$this->cmsSettings['to2'],
                              'type'=>$this->cmsSettings['method2'], 'amount'=>$this->cmsSettings['methodval2']);
        }
        if( !empty( $this->cmsSettings['from3'] ) &&  !empty( $this->cmsSettings['to3'] ) && !empty( $this->cmsSettings['method3'] ) &&
            !empty( $this->cmsSettings['methodval3'] ) )
        {
            $result[] = array('min' => $this->cmsSettings['from3'], 'max'=>$this->cmsSettings['to3'],
                              'type'=>$this->cmsSettings['method3'], 'amount'=>$this->cmsSettings['methodval3']);
        }
        return $result;
        /*
        return array(
            array('min' => 0, 'max'=>100, 'type'=>self::INTERVAL_RULES_MARKET_AMOUNT, 'amount'=>30),
            array('min' => 100, 'max'=>200, 'type'=>self::INTERVAL_RULES_CLIENT_ALL, 'amount'=>60),
            array('min' => 300, 'max'=>400, 'type'=>self::INTERVAL_RULES_MARKET_PERCENT, 'amount'=>3),
            array('min' => 1000, 'max'=>null, 'type'=>self::INTERVAL_RULES_MARKET_ALL),
        );
        */
    }

    /**
     * РўРёРї РѕРєСЂСѓРіР»РµРЅРёСЏ
     * @return int
     */
    public function aroundPriceType()
    {
        switch ($this->cmsSettings['okrugl'])
        {
            case '0': return self::AROUND_FLOOR;
            case '1': return self::AROUND_CEIL;
            case '2': return self::AROUND_ROUND;
            default : return self::AROUND_ROUND;
        }
        //return self::AROUND_ROUND; // self::AROUND_FLOOR, self::AROUND_CEIL
    }

    /**
     * РЁР°Рі РѕРєСЂСѓРіР»РµРЅРёСЏ
     * @return float
     */
    public function aroundPriceStep()
    {
        $this->cmsSettings['shag'];
        return $this->cmsSettings['shag']; // Р”Рѕ 50 РєРѕРїРµРµРє
        // TODO: Implement aroundPriceStep() method.
    }

    /**
     * РѕРїРёСЃР°РЅРёРµ СЃРѕР±СЃС‚РІРµРЅРЅС‹С… СЃР»СѓР¶Р± РґРѕСЃС‚Р°РІРєРё
     * @return string
     */
    public function getCustomPointsString(){
        return $this->cmsSettings['custom_point'];
    }

    /**
     * Р•СЃР»Рё РІС‹ Р·РЅР°РµС‚Рµ РёРјСЏ РїРѕРєСѓРїР°С‚РµР»СЏ, СЃРґРµР»Р°Р№С‚Рµ С‡С‚РѕР±С‹ РѕРЅРѕ РІРµСЂРЅСѓР»РѕСЃСЊ РІ СЌС‚РѕРј РјРµС‚РѕРґРµ
     * @return string|null
     */
    public function getClientFirstName() {
        if( isset( $this->fields['fio_new'])  ){
            return trim($this->fields['fio_new']);
        }
        return '';
    }



    /**
     * Р•СЃР»Рё РІС‹ Р·РЅР°РµС‚Рµ С‚РµР»РµС„РѕРЅ РїРѕРєСѓРїР°С‚РµР»СЏ, СЃРґРµР»Р°Р№С‚Рµ С‡С‚РѕР±С‹ РѕРЅРѕ РІРµСЂРЅСѓР»РѕСЃСЊ
     * РІ СЌС‚РѕРј РјРµС‚РѕРґРµ. 10 СЃРёРјРІРѕР»РѕРІ, РЅР°РїСЂРёРјРµСЂ 9211234567
     *
     *@return string|null
     */
    public function getClientPhone() {
        if( isset( $this->fields['tel_new'])  ){
            $tel_name = $this->formatPhone( $this->fields['tel_new'] );
            $tel_name  = substr( $tel_name, -10);
            return '+7' . $tel_name;
        }
        return '';
    }

    public function getClientEmail(){
        if( isset( $this->fields['mail'])  ){
            return $this->fields['mail'];
        }
        return;
    }

    /**
     * пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ пїЅпїЅ пїЅпїЅпїЅпїЅпїЅпїЅ пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ пїЅпїЅпїЅпїЅпїЅпїЅпїЅпїЅ пїЅпїЅпїЅпїЅпїЅпїЅпїЅ
     *
     * @param string $phone
     *
     * @return string
     */
    public function formatPhone( $phone ){
        return preg_replace( array('/-/', '/\(/', '/\)/', '/\+7/', '/\s\s+/'), '', $phone );
    }
    /**
     * Р’РµСЂРЅРё РјР°СЃСЃРёРІ РђРґСЂРµСЃ, Р”РѕРј, РљРѕСЂРїСѓСЃ, РљРІР°СЂС‚РёСЂР°. Р•СЃР»Рё РЅРµ РјРѕР¶РµС€СЊ РјРѕР¶РЅРѕ РІРµСЂРЅСѓС‚СЊ РІСЃРµ РІ РѕРґРЅРѕРј РїРѕР»Рµ Рё РЅР°СЃС‚СЂРѕРёС‚СЊ С‡РµСЂРµР· get*RequiredFields
     * @return string[]
     */
    public function getClientAddress() {
        $street = '';
        $house = '';
        $corpus = '';
        $flat = '';
        if( isset( $this->fields['street_new']) ){
            $street = $this->fields['street_new'];
        }
        if( isset( $this->fields['house_new']) ){
            $house = $this->fields['house_new'];
        }
        if( isset( $this->fields['flat_new']) ){
            $flat = $this->fields['flat_new'];
        }
        return array( $street, $house, $corpus, $flat );
    }

    /**
     * Р’РµСЂРЅРёС‚Рµ id РіРѕСЂРѕРґР° РІ СЃРёСЃС‚РµРјРµ DDelivery
     * @return int
     */
    public function getClientCityId()
    {
        // Р•СЃР»Рё РЅРµС‚ РёРЅС„РѕСЂРјР°С†РёРё Рѕ РіРѕСЂРѕРґРµ, РѕСЃС‚Р°РІСЊС‚Рµ РІС‹Р·РѕРІ СЂРѕРґРёС‚РµР»СЊСЃРєРѕРіРѕ РјРµС‚РѕРґР°.
        return parent::getClientCityId();
    }

    /**
     * Р’РѕР·РІСЂР°С‰Р°РµС‚ РїРѕРґРґРµСЂР¶РёРІР°РµРјС‹Рµ РјР°РіР°Р·РёРЅРѕРј СЃРїРѕСЃРѕР±С‹ РґРѕСЃС‚Р°РІРєРё
     * @return array
     */
    public function getSupportedType()
    {
        if( $this->cmsSettings['type'] == '3' ){
            $settings = json_decode($this->cmsSettings['settings'], true);
            if( in_array($_GET['dostavka_metod'], $settings['self_way']) ){
                return array(
                    \DDelivery\Sdk\DDeliverySDK::TYPE_SELF
                );
            }elseif(in_array($_GET['dostavka_metod'], $settings['courier_way'])){
                return array(
                    \DDelivery\Sdk\DDeliverySDK::TYPE_COURIER
                );
            }else{
                return array(
                    \DDelivery\Sdk\DDeliverySDK::TYPE_SELF,
                    \DDelivery\Sdk\DDeliverySDK::TYPE_COURIER
                );
            }
        }
        elseif($this->cmsSettings['type'] == '1'){
            return array(
                \DDelivery\Sdk\DDeliverySDK::TYPE_SELF
            );
        }elseif($this->cmsSettings['type'] == '2'){
            return array(
                \DDelivery\Sdk\DDeliverySDK::TYPE_COURIER,
            );
        }else{
            return array(
                \DDelivery\Sdk\DDeliverySDK::TYPE_SELF,
                \DDelivery\Sdk\DDeliverySDK::TYPE_COURIER
            );
        }
    }

    /**
     * Р’РѕР·РІСЂР°С‰Р°РµС‚ Р±РёРЅР°СЂРЅСѓСЋ РјР°СЃРєСѓ РѕР±СЏР·Р°С‚РµР»СЊРЅС‹С… РїРѕР»РµР№ РґР»СЏ РєСѓСЂСЊРµСЂР°
     * Р•СЃР»Рё СЂРµРґР°РєС‚РёСЂРѕРІР°РЅРёРµ РЅРµ РІРєР»СЋС‡РµРЅРѕ, РЅРѕ РµСЃС‚СЊ РѕР±СЏР·Р°С‚РµР»СЊРЅРѕСЃС‚СЊ С‚Рѕ РїРѕР»Рµ РїРѕСЏРІРёС‚СЃСЏ
     * Р•СЃР»Рё СЂРµРґР°РєС‚РёСЂСѓРµРјС‹С… РїРѕР»РµР№ РЅРµ Р±СѓРґРµС‚ С‚Рѕ РїСЂРѕРїСѓСЃС‚РёРј С€Р°Рі
     * @return int
     */
    public function getCourierRequiredFields(){
        // ВВести все обязательно, кроме корпуса
        return self::FIELD_EDIT_FIRST_NAME | self::FIELD_REQUIRED_FIRST_NAME
        | self::FIELD_EDIT_PHONE | self::FIELD_REQUIRED_PHONE
        | self::FIELD_EDIT_ADDRESS | self::FIELD_REQUIRED_ADDRESS
        | self::FIELD_EDIT_ADDRESS_HOUSE | self::FIELD_REQUIRED_ADDRESS_HOUSE
        | self::FIELD_EDIT_ADDRESS_HOUSING
        | self::FIELD_EDIT_ADDRESS_FLAT | self::FIELD_REQUIRED_ADDRESS_FLAT | self::FIELD_EDIT_EMAIL
        | self::FIELD_EDIT_INDEX;
    }

    /**
     * Р’РѕР·РІСЂР°С‰Р°РµС‚ Р±РёРЅР°СЂРЅСѓСЋ РјР°СЃРєСѓ РѕР±СЏР·Р°С‚РµР»СЊРЅС‹С… РїРѕР»РµР№ РґР»СЏ РїСѓРЅРєС‚РѕРІ СЃР°РјРѕРІС‹РІРѕР·Р°
     * Р•СЃР»Рё СЂРµРґР°РєС‚РёСЂРѕРІР°РЅРёРµ РЅРµ РІРєР»СЋС‡РµРЅРѕ, РЅРѕ РµСЃС‚СЊ РѕР±СЏР·Р°С‚РµР»СЊРЅРѕСЃС‚СЊ С‚Рѕ РїРѕР»Рµ РїРѕСЏРІРёС‚СЃСЏ
     * Р•СЃР»Рё СЂРµРґР°РєС‚РёСЂСѓРµРјС‹С… РїРѕР»РµР№ РЅРµ Р±СѓРґРµС‚ С‚Рѕ РїСЂРѕРїСѓСЃС‚РёРј С€Р°Рі
     * @return int
     */
    public function getSelfRequiredFields()
    {
        // пїЅ?РјСЏ, С„Р°РјРёР»РёСЏ, РјРѕР±РёР»РєР°
        return self::FIELD_EDIT_FIRST_NAME | self::FIELD_REQUIRED_FIRST_NAME
        | self::FIELD_EDIT_PHONE | self::FIELD_REQUIRED_PHONE;
    }


    /**
     * РџРѕР»СѓС‡РёС‚СЊ РґРѕСЃС‚СѓРїРЅС‹Рµ СЃРїРѕСЃРѕР±С‹ РѕРїР»Р°С‚С‹ РґР»СЏ РЎР°РјРѕРІС‹РІРѕР·Р° ( РјРѕР¶РЅРѕ Р°РЅР°Р»РёР·РёСЂРѕРІР°С‚СЊ СЃРѕРґРµСЂР¶РёРјРѕРµ order )
     * @param $order DDeliveryOrder
     * @return array
     */
    public function getSelfPaymentVariants( $order ){

        $self_list = unserialize( $this->cmsSettings['self_list'] );
        if( !is_array($self_list)){
            $self_list = array();
        }
        return $self_list;
    }

    /**
     * РџРѕР»СѓС‡РёС‚СЊ РґРѕСЃС‚СѓРїРЅС‹Рµ СЃРїРѕСЃРѕР±С‹ РѕРїР»Р°С‚С‹ РґР»СЏ РєСѓСЂСЊРµСЂР° ( РјРѕР¶РЅРѕ Р°РЅР°Р»РёР·РёСЂРѕРІР°С‚СЊ СЃРѕРґРµСЂР¶РёРјРѕРµ order )
     * @param $order DDeliveryOrder
     * @return array
     */
    public function getCourierPaymentVariants( $order ){
        $courier_list = unserialize( $this->cmsSettings['courier_list'] );
        if( !is_array($courier_list)){
            $courier_list = array();
        }
        return $courier_list;
    }
    public function onFinishResultReturn(  $order, $resultArray  ){
        if($order->type == \DDelivery\Sdk\DDeliverySDK::TYPE_SELF){
            $resultArray['payment'] = $this->getSelfPaymentVariants( $order );
        }else{
            $resultArray['payment'] = $this->getCourierPaymentVariants( $order );
        }
        $resultArray['type'] = $order->type;
        return $resultArray;
    }

    public function  getCaptions(){
        return array(
                    'CAPTION1' =>'DDelivery. Доставка в удобную Вам точку.',
                    'CAPTION2' =>'Подождите пожалуйста, мы ищем лучшие предложения',
                    'CAPTION3' =>'Произошла ошибка, ',
                    'CAPTION4' =>'повторить запрос',
                    'CAPTION5' =>'Сервис доставки DDelivery.ru',
                    'CAPTION6' =>'Ячейка',
                    'CAPTION7' =>'Живой пункт',
                    'CAPTION8' =>'Наличными',
                    'CAPTION9' =>'Банковскими картами',
                    'CAPTION10' =>'Предоплата',
        );
    }

} 
